<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Test del Ala - Checklist de Mejoras</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background: linear-gradient(to bottom, #87CEEB, #FFFFFF);
            overflow: hidden;
        }
        #controls {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(255,255,255,0.95);
            padding: 15px;
            border-radius: 10px;
            max-width: 250px;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        #checklist {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(255,255,255,0.95);
            padding: 15px;
            border-radius: 10px;
            max-width: 350px;
            max-height: 80vh;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        /* Responsive adjustments */
        @media (max-width: 1200px) {
            #controls {
                max-width: 200px;
                padding: 12px;
            }
            #checklist {
                max-width: 300px;
                right: 5px;
                padding: 12px;
            }
        }

        @media (max-width: 900px) {
            #controls {
                position: absolute;
                top: auto;
                bottom: 10px;
                left: 10px;
                max-width: calc(100vw - 20px);
                padding: 15px;
                border-radius: 12px;
            }
            #checklist {
                position: absolute;
                top: 10px;
                right: 10px;
                left: 10px;
                max-width: calc(100vw - 20px);
                max-height: 35vh;
                padding: 15px;
                border-radius: 12px;
            }
            #controls input[type="range"] {
                width: 100%;
                height: 8px;
                margin: 10px 0;
            }
            #controls button {
                width: 100%;
                padding: 12px;
                margin: 5px 0;
                font-size: 16px;
                min-height: 44px;
            }
        }

        /* Mobile specific optimizations */
        @media (max-width: 768px) {
            body {
                overflow: hidden !important; /* Prevent body scrolling on mobile */
            }

            /* Hide desktop elements on mobile */
            #controls {
                display: none !important; /* Hide desktop controls */
            }

            #checklist {
                display: none !important; /* Hide desktop checklist */
            }

            /* Show mobile elements */
            #mobile-menu-toggle {
                display: block !important;
                position: fixed !important;
                top: 10px !important;
                left: 10px !important;
                z-index: 1001 !important;
                width: 56px !important;
                height: 56px !important;
                border-radius: 50% !important;
                background: linear-gradient(135deg, #2196F3, #1976D2) !important;
                color: white !important;
                border: none !important;
                font-size: 24px !important;
                cursor: pointer !important;
                box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3) !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                transition: all 0.2s ease !important;
                -webkit-tap-highlight-color: transparent !important;
            }

            #mobile-menu-toggle:hover {
                transform: scale(1.05) !important;
                box-shadow: 0 6px 16px rgba(33, 150, 243, 0.4) !important;
            }

            #mobile-menu-toggle:active {
                transform: scale(0.95) !important;
            }

            /* Mobile controls panel */
            #mobile-controls {
                display: block !important;
                position: fixed !important;
                bottom: 0 !important;
                left: 0 !important;
                right: 0 !important;
                background: rgba(255,255,255,0.95) !important;
                padding: 15px !important;
                border-radius: 12px 12px 0 0 !important;
                font-size: 14px !important;
                z-index: 1000 !important;
                box-shadow: 0 -2px 10px rgba(0,0,0,0.1) !important;
                max-height: 40vh !important;
                overflow-y: auto !important;
            }

            /* Mobile checklist (side menu) */
            #mobile-checklist {
                display: block !important;
                position: fixed !important;
                top: 0 !important;
                left: -100% !important; /* Hidden by default */
                width: 80% !important;
                max-width: 300px !important;
                height: 100vh !important;
                background: rgba(255,255,255,0.98) !important;
                border-radius: 0 !important;
                padding: 20px !important;
                font-size: 13px !important;
                transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important; /* Smooth easing */
                z-index: 1000 !important;
                overflow-y: auto !important;
                box-shadow: 2px 0 10px rgba(0,0,0,0.1) !important;
                will-change: left !important; /* Performance optimization */
                transform: translateZ(0) !important; /* Hardware acceleration */
            }

            #mobile-checklist.open {
                left: 0 !important;
            }

            /* Mobile overlay */
            #mobile-overlay {
                display: none !important;
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100% !important;
                height: 100% !important;
                background: rgba(0, 0, 0, 0.5) !important;
                z-index: 999 !important;
                opacity: 0 !important;
                transition: opacity 0.3s ease !important;
            }

            #mobile-overlay.show {
                display: block !important;
                opacity: 1 !important;
            }

            /* Mobile-specific styles */
            #mobile-controls input[type="range"] {
                width: 100% !important;
                height: 8px !important;
                margin: 10px 0 !important;
            }

            #mobile-controls button {
                width: 48% !important;
                padding: 12px !important;
                margin: 2px !important;
                font-size: 14px !important;
                min-height: 44px !important;
            }

            #mobile-controls label {
                display: block !important;
                margin: 8px 0 !important;
                font-size: 14px !important;
            }

            #mobile-controls input[type="checkbox"] {
                width: 20px !important;
                height: 20px !important;
                margin-right: 8px !important;
            }

            .check-item {
                padding: 8px !important;
                margin: 6px 0 !important;
                font-size: 12px !important;
            }
        }

        /* Small mobile devices */
        @media (max-width: 480px) {
            #controls {
                padding: 10px;
                font-size: 13px;
            }
            #checklist {
                padding: 10px;
                max-height: 25vh;
                font-size: 12px;
            }
            #controls button {
                padding: 10px;
                font-size: 14px;
            }
            .check-item {
                padding: 6px;
                font-size: 11px;
            }
        }

        /* Touch device optimizations */
        @media (hover: none) and (pointer: coarse) {
            #controls input[type="range"], #mobile-controls input[type="range"] {
                height: 12px;
                -webkit-appearance: none;
                appearance: none;
                background: #ddd;
                border-radius: 6px;
                touch-action: manipulation; /* Prevent zoom on touch */
            }
            #controls input[type="range"]::-webkit-slider-thumb, #mobile-controls input[type="range"]::-webkit-slider-thumb {
                -webkit-appearance: none;
                appearance: none;
                width: 28px;
                height: 28px;
                border-radius: 50%;
                background: #2196F3;
                cursor: pointer;
                touch-action: manipulation;
            }
            #controls button, #mobile-controls button {
                -webkit-tap-highlight-color: rgba(33, 150, 243, 0.3);
                touch-action: manipulation;
                min-height: 48px; /* Accessibility standard */
            }
            #checklist, #mobile-checklist {
                -webkit-overflow-scrolling: touch;
                overscroll-behavior: contain;
            }
            /* Prevent accidental zoom on form elements */
            input, button, select, textarea {
                touch-action: manipulation;
                -webkit-touch-callout: none;
                -webkit-user-select: none;
                user-select: none;
            }
            /* Re-enable text selection for inputs */
            input[type="text"], textarea {
                -webkit-user-select: text;
                user-select: text;
            }
        }

        /* Prevent text selection on touch */
        @media (hover: none) {
            * {
                -webkit-touch-callout: none;
                -webkit-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
            }
            input, button, textarea, select {
                -webkit-user-select: text;
                -moz-user-select: text;
                -ms-user-select: text;
                user-select: text;
            }
        }

        #mobile-menu-toggle {
            display: none;
            position: fixed;
            top: 10px;
            left: 10px;
            z-index: 1001;
        }

        #mobile-menu-toggle button {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #2196F3, #1976D2);
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            -webkit-tap-highlight-color: transparent;
        }

        #mobile-menu-toggle button:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 16px rgba(33, 150, 243, 0.4);
        }

        #mobile-menu-toggle button:active {
            transform: scale(0.95);
        }

        #breadcrumb {
            display: none;
            position: fixed;
            top: 10px;
            left: 80px;
            right: 80px;
            background: rgba(255,255,255,0.95);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        #breadcrumb span {
            color: #666;
        }

        #breadcrumb strong {
            color: #2196F3;
        }

        #back-button {
            display: none;
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1001;
        }

        #back-button button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #2196F3, #1976D2);
            color: white;
            border: none;
            font-size: 18px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        #back-button button:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.4);
        }

        #back-button button:active {
            transform: scale(0.95);
        }

        #checklist-header {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 10px;
        }

        #checklist-header h3 {
            margin: 0;
            font-size: 16px;
            color: #333;
        }

        #search-container {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        #checklist-search {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            background: white;
        }

        #checklist-search:focus {
            outline: none;
            border-color: #2196F3;
            box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.2);
        }

        #clear-search {
            width: 30px;
            height: 30px;
            border: none;
            background: #f0f0f0;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: #666;
        }

        #clear-search:hover {
            background: #e0e0e0;
        }

        #close-menu-btn {
            align-self: flex-end;
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #666;
            padding: 5px;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #quick-actions {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
        }

        #quick-actions button {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        #quick-actions button:hover {
            background: #f5f5f5;
            border-color: #2196F3;
        }

        #quick-actions button:active {
            transform: scale(0.95);
        }
        .check-item { margin: 8px 0; padding: 5px; border-radius: 5px; }
        .check-item.completed { background: #e8f5e8; border-left: 4px solid #4CAF50; }
        .check-item.pending { background: #fff3cd; border-left: 4px solid #ffc107; }
        .check-item.improvement { background: #e3f2fd; border-left: 4px solid #2196F3; }

        /* Collapsible checklist styles */
        .checklist-category {
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
        }

        .category-header {
            background: #f5f5f5;
            padding: 12px 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .category-header:hover {
            background: #e8f4fd;
        }

        .category-header h4 {
            margin: 0;
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }

        .toggle-icon {
            font-size: 12px;
            color: #666;
            transition: transform 0.2s ease;
        }

        .category-content {
            padding: 0;
        }

        .category-content .check-item {
            border-bottom: 1px solid #f0f0f0;
            margin: 0;
            border-radius: 0;
        }

        .category-content .check-item:last-child {
            border-bottom: none;
        }
        .status { font-weight: bold; font-size: 12px; }
        .completed { color: #4CAF50; }
        .pending { color: #ff9800; }
        .improvement { color: #2196F3; }
    </style>
</head>
<body>
    <div id="mobile-menu-toggle">
        <button id="menu-btn" onclick="toggleMobileMenu()">‚ò∞</button>
    </div>

    <div id="breadcrumb">
        <span>Simulador</span> > <strong>Checklist de Mejoras</strong>
    </div>

    <div id="back-button">
        <button onclick="goBack()">‚Üê</button>
    </div>

    <div id="mobile-overlay" onclick="closeMobileMenu()"></div>

    <div id="controls">
        <h3>Controles de Test</h3>
        <label>√Ångulo de Ataque: <span id="angle-value">5</span>¬∞</label><br>
        <input type="range" id="angle-slider" min="0" max="25" value="5" step="1"><br><br>
        <label>Mostrar Detalles:</label><br>
        <input type="checkbox" id="show-details" checked> Etiquetas<br>
        <input type="checkbox" id="show-pressure" checked> Presiones<br>
        <input type="checkbox" id="show-flows" checked> Flujos<br>
        <input type="checkbox" id="show-forces" checked> Fuerzas<br><br>
        <div id="quick-actions">
            <button onclick="quickPreset('all')">Mostrar Todo</button>
            <button onclick="quickPreset('minimal')">M√≠nimo</button>
            <button onclick="quickPreset('physics')">Solo F√≠sica</button>
        </div>
    </div>

    <div id="checklist">
        <div id="checklist-header">
            <h3>Checklist de Mejoras del Ala</h3>
            <div id="search-container">
                <input type="text" id="checklist-search" placeholder="Buscar..." oninput="filterChecklist(this.value)">
                <button id="clear-search" onclick="clearSearch()" style="display: none;">‚úï</button>
            </div>
            <button id="close-menu-btn" onclick="closeMobileMenu()">‚úï</button>
        </div>
        <div id="checklist-items"></div>
    </div>

    <!-- Mobile elements (hidden on desktop) -->
    <div id="mobile-controls" style="display: none;">
        <h3>Controles de Test</h3>
        <label>√Ångulo de Ataque: <span id="mobile-angle-value">5</span>¬∞</label><br>
        <input type="range" id="mobile-angle-slider" min="0" max="25" value="5" step="1"><br><br>
        <label>Mostrar Detalles:</label><br>
        <input type="checkbox" id="mobile-show-details" checked> Etiquetas<br>
        <input type="checkbox" id="mobile-show-pressure" checked> Presiones<br>
        <input type="checkbox" id="mobile-show-flows" checked> Flujos<br>
        <input type="checkbox" id="mobile-show-forces" checked> Fuerzas<br><br>
        <div id="mobile-quick-actions">
            <button onclick="quickPreset('all')">Mostrar Todo</button>
            <button onclick="quickPreset('minimal')">M√≠nimo</button>
            <button onclick="quickPreset('physics')">Solo F√≠sica</button>
        </div>
    </div>

    <div id="mobile-checklist">
        <div id="mobile-checklist-header">
            <h3>Checklist de Mejoras del Ala</h3>
            <div id="mobile-search-container">
                <input type="text" id="mobile-checklist-search" placeholder="Buscar..." oninput="filterMobileChecklist(this.value)">
                <button id="mobile-clear-search" onclick="clearMobileSearch()" style="display: none;">‚úï</button>
            </div>
            <button id="mobile-close-menu-btn" onclick="closeMobileMenu()">‚úï</button>
        </div>
        <div id="mobile-checklist-items"></div>
    </div>

    <script>
        let angleSlider, showDetails, showPressure, showFlows, showForces;
        let angleAttack = radians(5);
        let flowOffset = 0;

        // Checklist data
        const checklistItems = [
            // Vista del Ala
            { category: "Vista del Ala", item: "Perfil NACA 2412 preciso", status: "completed", description: "Curvas de Bezier implementadas correctamente" },
            { category: "Vista del Ala", item: "Grosor del perfil realista", status: "completed", description: "Borde interior y borde de ataque reforzado" },
            { category: "Vista del Ala", item: "Textura met√°lica", status: "completed", description: "Gradientes met√°licos y brillos especulares implementados" },
            { category: "Vista del Ala", item: "Sombras 3D", status: "completed", description: "Sombras volum√©tricas con direcci√≥n de luz" },
            { category: "Vista del Ala", item: "Detalles de superficie", status: "completed", description: "Paneles, remaches y antenas GPS agregados" },
            { category: "Vista del Ala", item: "Efectos de desgaste", status: "completed", description: "Manchas de uso e hielo en condiciones espec√≠ficas" },

            // Flujos de Aire
            { category: "Flujos de Aire", item: "L√≠neas de corriente superiores", status: "completed", description: "Flujos azules siguiendo contorno superior" },
            { category: "Flujos de Aire", item: "L√≠neas de corriente inferiores", status: "completed", description: "Flujos naranjas siguiendo contorno inferior" },
            { category: "Flujos de Aire", item: "Part√≠culas animadas", status: "completed", description: "Puntos siguiendo las l√≠neas de flujo" },
            { category: "Flujos de Aire", item: "Velocidad variable por √°ngulo", status: "completed", description: "Flujos m√°s r√°pidos en √°ngulos altos" },
            { category: "Flujos de Aire", item: "Efectos de turbulencia", status: "pending", description: "Ondulaciones y remolinos en stall" },
            { category: "Flujos de Aire", item: "Separaci√≥n del flujo", status: "completed", description: "Efectos cuando Œ± > 12¬∞" },
            { category: "Flujos de Aire", item: "Boundary layer visualization", status: "improvement", description: "Capa l√≠mite visible cerca de la superficie" },

            // Presiones
            { category: "Presiones", item: "Gradiente de presi√≥n superior", status: "completed", description: "Azul para baja presi√≥n" },
            { category: "Presiones", item: "Gradiente de presi√≥n inferior", status: "completed", description: "Rojo para alta presi√≥n" },
            { category: "Presiones", item: "L√≠neas de contorno", status: "completed", description: "Isobaras curvas" },
            { category: "Presiones", item: "Animaci√≥n de contornos", status: "pending", description: "Contornos ondulantes con el tiempo" },
            { category: "Presiones", item: "Valores num√©ricos", status: "improvement", description: "Mostrar valores de presi√≥n en Pa" },
            { category: "Presiones", item: "Efectos de compresibilidad", status: "improvement", description: "Cambios en altas velocidades" },

            // Fuerzas
            { category: "Fuerzas", item: "Flecha de sustentaci√≥n", status: "completed", description: "Verde desde borde de ataque" },
            { category: "Fuerzas", item: "Flecha de peso", status: "completed", description: "Roja hacia abajo" },
            { category: "Fuerzas", item: "Fuerza de arrastre", status: "pending", description: "Flecha horizontal de resistencia" },
            { category: "Fuerzas", item: "Momento de cabeceo", status: "improvement", description: "Torque alrededor del centro aerodin√°mico" },
            { category: "Fuerzas", item: "Centro de presi√≥n", status: "improvement", description: "Punto donde act√∫a la fuerza resultante" },

            // Interactividad
            { category: "Interactividad", item: "Control de √°ngulo de ataque", status: "completed", description: "Slider funcional 0-25¬∞" },
            { category: "Interactividad", item: "Animaci√≥n autom√°tica", status: "pending", description: "Modo demo con √°ngulos variables" },
            { category: "Interactividad", item: "Zoom y pan", status: "improvement", description: "Acercamiento a detalles espec√≠ficos" },
            { category: "Interactividad", item: "Modo comparaci√≥n", status: "improvement", description: "Comparar diferentes perfiles NACA" },
            { category: "Interactividad", item: "Captura de pantalla", status: "pending", description: "Guardar im√°genes del estado actual" },

            // F√≠sica
            { category: "F√≠sica", item: "Principio de Bernoulli", status: "completed", description: "Velocidad ‚Üî Presi√≥n correctamente mostrado" },
            { category: "F√≠sica", item: "Coeficiente de sustentaci√≥n", status: "completed", description: "Cl = 2œÄ sin(Œ±) aproximado" },
            { category: "F√≠sica", item: "Efecto stall", status: "completed", description: "P√©rdida de sustentaci√≥n >15¬∞" },
            { category: "F√≠sica", item: "Reynolds number", status: "improvement", description: "Considerar n√∫mero de Reynolds" },
            { category: "F√≠sica", item: "Efectos de Mach", status: "improvement", description: "Compresibilidad en altas velocidades" }
        ];

        // Nuevas Caracter√≠sticas a Probar
        const newFeaturesToTest = [
            { category: "Nuevas Caracter√≠sticas a Probar", item: "Pruebas espec√≠ficas para el sistema de flujo aerodin√°mico con curvas B√©zier", status: "pending", description: "Validar comportamiento de flujos con las nuevas curvas NACA precisas" },
            { category: "Nuevas Caracter√≠sticas a Probar", item: "Validaci√≥n de la f√≠sica de part√≠culas en diferentes condiciones clim√°ticas", status: "pending", description: "Probar part√≠culas en lluvia, nieve y condiciones normales" },
            { category: "Nuevas Caracter√≠sticas a Probar", item: "Pruebas de estabilidad del sistema de sombras 3D y texturas met√°licas", status: "pending", description: "Verificar rendimiento y estabilidad de efectos visuales avanzados" },
            { category: "Nuevas Caracter√≠sticas a Probar", item: "Verificaci√≥n de la correcta separaci√≥n de flujos superior/inferior del ala", status: "pending", description: "Confirmar que los flujos se separan correctamente en la superficie del ala" }
        ];

        // Combine all checklist items
        const allChecklistItems = [...checklistItems, ...newFeaturesToTest];

        let cloudOffset = 0;
        let scaleFactor = 1;

        function getResponsiveTextSize(baseSize) {
            return max(8, baseSize * scaleFactor);
        }

        let touchStartX = 0;
        let touchStartY = 0;
        let touchEndX = 0;
        let touchEndY = 0;

        function initSwipeGestures() {
            // Remove existing listeners to prevent duplicates
            document.removeEventListener('touchstart', handleTouchStart);
            document.removeEventListener('touchmove', handleTouchMove);
            document.removeEventListener('touchend', handleTouchEnd);

            // Add touch event listeners to the document
            document.addEventListener('touchstart', handleTouchStart, { passive: false });
            document.addEventListener('touchmove', handleTouchMove, { passive: false });
            document.addEventListener('touchend', handleTouchEnd, { passive: false });
        }

        function handleTouchStart(e) {
            touchStartX = e.changedTouches[0].screenX;
            touchStartY = e.changedTouches[0].screenY;
        }

        function handleTouchMove(e) {
            if (!touchStartX || !touchStartY) return;

            const touchEndX = e.changedTouches[0].screenX;
            const touchEndY = e.changedTouches[0].screenY;
            const diffX = touchStartX - touchEndX;
            const diffY = touchStartY - touchEndY;

            // Only prevent default if it's a horizontal swipe near the edges
            const isNearEdge = touchStartX < 50 || touchStartX > window.innerWidth - 50;
            const isHorizontalSwipe = Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50;

            if (isNearEdge && isHorizontalSwipe) {
                e.preventDefault();
            }
        }

        function handleTouchEnd(e) {
            if (!touchStartX || !touchStartY) return;

            const touchEndX = e.changedTouches[0].screenX;
            const touchEndY = e.changedTouches[0].screenY;
            const diffX = touchStartX - touchEndX;
            const diffY = touchStartY - touchEndY;

            // Reset touch coordinates
            touchStartX = null;
            touchStartY = null;

            handleSwipeGesture(diffX, diffY);
        }

        function handleSwipeGesture(diffX, diffY) {
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth < 768;
            if (!isMobile) return;

            const minSwipeDistance = 50;
            const mobileChecklist = document.getElementById('mobile-checklist');
            const isOpen = mobileChecklist && mobileChecklist.classList.contains('open');

            // Swipe from left edge to open menu
            if (diffX < -minSwipeDistance && !isOpen && touchStartX < 50) {
                openMobileMenu();
            }
            // Swipe right to close menu
            else if (diffX > minSwipeDistance && isOpen) {
                closeMobileMenu();
            }
        }

        function setup() {
            // Detect mobile devices
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth < 768;

            // Calculate canvas size based on device
            let canvasWidth, canvasHeight;

            if (isMobile) {
                canvasWidth = window.innerWidth;
                canvasHeight = window.innerHeight - 80; // Optimized: leave minimal space for controls
                scaleFactor = min(canvasWidth / 800, canvasHeight / 500);
            } else {
                canvasWidth = min(windowWidth - 300, 1200);
                canvasHeight = min(windowHeight - 100, 700);
                scaleFactor = min(canvasWidth / 1000, canvasHeight / 600);
            }

            createCanvas(canvasWidth, canvasHeight);
            smooth();

            // Initialize desktop controls
            angleSlider = select('#angle-slider');
            showDetails = select('#show-details');
            showPressure = select('#show-pressure');
            showFlows = select('#show-flows');
            showForces = select('#show-forces');

            // Initialize mobile controls
            mobileAngleSlider = select('#mobile-angle-slider');
            mobileShowDetails = select('#mobile-show-details');
            mobileShowPressure = select('#mobile-show-pressure');
            mobileShowFlows = select('#mobile-show-flows');
            mobileShowForces = select('#mobile-show-forces');

            // Set up event listeners for both desktop and mobile
            if (angleSlider) angleSlider.input(updateAngle);
            if (mobileAngleSlider) mobileAngleSlider.input(updateAngle);

            // Connect mobile quick action buttons
            const mobileQuickActions = select('#mobile-quick-actions');
            if (mobileQuickActions) {
                const mobileButtons = mobileQuickActions.elt.querySelectorAll('button');
                mobileButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        const preset = this.textContent.toLowerCase().includes('todo') ? 'all' :
                                     this.textContent.toLowerCase().includes('m√≠nimo') ? 'minimal' : 'physics';
                        quickPreset(preset);
                    });
                });
            }

            updateAngle(); // Initialize

            displayChecklist();

            // Add swipe gesture support for mobile
            if (isMobile) {
                initSwipeGestures();
                initOrientationChange();
                initMobileUI();
            }

            // Initialize lazy loading for any images
            initLazyLoading();
        }

        function initMobileUI() {
            // Ensure mobile elements are in correct initial state
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth < 768;

            if (isMobile) {
                const menuToggle = document.getElementById('mobile-menu-toggle');
                const breadcrumb = document.getElementById('breadcrumb');
                const backBtn = document.getElementById('back-button');
                const checklist = document.getElementById('checklist');

                if (menuToggle) menuToggle.style.display = 'block';
                if (breadcrumb) breadcrumb.style.display = 'none';
                if (backBtn) backBtn.style.display = 'none';
                if (checklist) checklist.classList.remove('open');
            }
        }

        function initOrientationChange() {
            window.addEventListener('orientationchange', function() {
                // Wait for orientation change to complete
                setTimeout(function() {
                    updateMobileLayout();
                    windowResized();
                }, 500);
            });
        }

        function initLazyLoading() {
            // Basic lazy loading for images (if any are added later)
            const images = document.querySelectorAll('img[data-src]');
            const imageObserver = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        img.src = img.dataset.src;
                        img.classList.remove('lazy');
                        observer.unobserve(img);
                    }
                });
            });

            images.forEach(img => imageObserver.observe(img));
        }

        function windowResized() {
            // Detect mobile devices
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth < 768;

            // Recalculate canvas size
            let canvasWidth, canvasHeight;

            if (isMobile) {
                canvasWidth = window.innerWidth;
                canvasHeight = window.innerHeight - 80; // Optimized: leave minimal space for controls
                scaleFactor = min(canvasWidth / 800, canvasHeight / 500);
            } else {
                canvasWidth = min(windowWidth - 300, 1200);
                canvasHeight = min(windowHeight - 100, 700);
                scaleFactor = min(canvasWidth / 1000, canvasHeight / 600);
            }

            resizeCanvas(canvasWidth, canvasHeight);

            // Update mobile layout based on orientation and screen size
            updateMobileLayout();
        }

        function updateMobileLayout() {
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth < 768;
            const isLandscape = window.innerWidth > window.innerHeight;

            if (isMobile) {
                const controls = document.getElementById('controls');
                const checklist = document.getElementById('checklist');
                const menuToggle = document.getElementById('mobile-menu-toggle');

                if (isLandscape) {
                    // Landscape: controls on left, checklist hidden by default
                    controls.style.bottom = '10px';
                    controls.style.left = '70px';
                    controls.style.right = '10px';
                    controls.style.maxWidth = 'none';
                    controls.style.maxHeight = 'calc(100vh - 20px)';

                    checklist.style.left = '-100%';
                    checklist.style.width = '70%';
                    checklist.style.maxWidth = '400px';

                    menuToggle.style.display = 'block';
                } else {
                    // Portrait: controls at bottom, checklist as overlay
                    controls.style.bottom = '10px';
                    controls.style.left = '70px';
                    controls.style.right = '10px';
                    controls.style.maxWidth = 'none';
                    controls.style.maxHeight = '35vh';

                    checklist.style.left = '-100%';
                    checklist.style.width = '80%';
                    checklist.style.maxWidth = '300px';

                    menuToggle.style.display = 'block';
                }
            } else {
                // Desktop: hide mobile elements
                const menuToggle = document.getElementById('mobile-menu-toggle');
                const breadcrumb = document.getElementById('breadcrumb');
                const backBtn = document.getElementById('back-button');

                if (menuToggle) menuToggle.style.display = 'none';
                if (breadcrumb) breadcrumb.style.display = 'none';
                if (backBtn) backBtn.style.display = 'none';
            }
        }

        function updateAngle() {
            // Get value from either desktop or mobile slider
            let angleDeg;
            if (angleSlider && angleSlider.value()) {
                angleDeg = angleSlider.value();
            } else if (mobileAngleSlider && mobileAngleSlider.value()) {
                angleDeg = mobileAngleSlider.value();
            } else {
                angleDeg = 5; // Default
            }

            // Update both displays
            select('#angle-value').html(angleDeg);
            select('#mobile-angle-value').html(angleDeg);
            angleAttack = radians(angleDeg);

            // Sync both sliders
            if (angleSlider) angleSlider.value(angleDeg);
            if (mobileAngleSlider) mobileAngleSlider.value(angleDeg);
        }

        function resetTest() {
            // Reset angle to 5 degrees
            if (angleSlider) angleSlider.value(5);
            if (mobileAngleSlider) mobileAngleSlider.value(5);
            updateAngle();

            // Reset desktop checkboxes
            const desktopDetails = select('#show-details');
            const desktopPressure = select('#show-pressure');
            const desktopFlows = select('#show-flows');
            const desktopForces = select('#show-forces');

            if (desktopDetails) desktopDetails.checked(true);
            if (desktopPressure) desktopPressure.checked(true);
            if (desktopFlows) desktopFlows.checked(true);
            if (desktopForces) desktopForces.checked(true);

            // Reset mobile checkboxes
            const mobileDetails = select('#mobile-show-details');
            const mobilePressure = select('#mobile-show-pressure');
            const mobileFlows = select('#mobile-show-flows');
            const mobileForces = select('#mobile-show-forces');

            if (mobileDetails) mobileDetails.checked(true);
            if (mobilePressure) mobilePressure.checked(true);
            if (mobileFlows) mobileFlows.checked(true);
            if (mobileForces) mobileForces.checked(true);
        }

        function toggleMobileMenu() {
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth < 768;
            const checklist = isMobile ? document.getElementById('mobile-checklist') : document.getElementById('checklist');
            const overlay = document.getElementById('mobile-overlay');
            const breadcrumb = document.getElementById('breadcrumb');
            const backBtn = document.getElementById('back-button');
            const isOpen = checklist.classList.contains('open');

            if (isOpen) {
                closeMobileMenu();
            } else {
                openMobileMenu();
            }
        }

        function openMobileMenu() {
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth < 768;
            const checklist = isMobile ? document.getElementById('mobile-checklist') : document.getElementById('checklist');
            const overlay = document.getElementById('mobile-overlay');
            const breadcrumb = document.getElementById('breadcrumb');
            const backBtn = document.getElementById('back-button');

            checklist.classList.add('open');
            overlay.classList.add('show');

            // Show breadcrumb and back button on mobile
            if (isMobile) {
                breadcrumb.style.display = 'block';
                backBtn.style.display = 'block';
            }
        }

        function closeMobileMenu() {
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth < 768;
            const checklist = isMobile ? document.getElementById('mobile-checklist') : document.getElementById('checklist');
            const overlay = document.getElementById('mobile-overlay');
            const breadcrumb = document.getElementById('breadcrumb');
            const backBtn = document.getElementById('back-button');

            checklist.classList.remove('open');
            overlay.classList.remove('show');

            // Hide breadcrumb and back button
            breadcrumb.style.display = 'none';
            backBtn.style.display = 'none';
        }

        function goBack() {
            // Simple back navigation - could be enhanced for more complex navigation
            closeMobileMenu();
        }

        function clearSearch() {
            // Clear desktop search inputs
            const desktopSearch = select('#checklist-search');

            if (desktopSearch) {
                desktopSearch.value('');
                desktopSearch.elt.focus();
            }

            // Re-filter with empty search
            filterChecklist('');
        }

        function clearMobileSearch() {
            // Clear mobile search input
            const mobileSearch = select('#mobile-checklist-search');

            if (mobileSearch) {
                mobileSearch.value('');
                mobileSearch.elt.focus();
            }

            // Re-filter with empty search
            filterMobileChecklist('');
        }

        function filterMobileChecklist(searchTerm) {
            const items = selectAll('#mobile-checklist .check-item');
            const lowerSearch = searchTerm.toLowerCase();

            items.forEach(item => {
                const text = item.elt.textContent.toLowerCase();
                if (text.includes(lowerSearch)) {
                    item.elt.style.display = 'block';
                } else {
                    item.elt.style.display = 'none';
                }
            });

            // Show/hide clear button for mobile
            const mobileClearBtn = select('#mobile-clear-search');
            if (mobileClearBtn) {
                mobileClearBtn.elt.style.display = searchTerm ? 'block' : 'none';
            }
        }

        function quickPreset(preset) {
            // Update desktop controls
            const desktopDetails = select('#show-details');
            const desktopPressure = select('#show-pressure');
            const desktopFlows = select('#show-flows');
            const desktopForces = select('#show-forces');

            // Update mobile controls
            const mobileDetails = select('#mobile-show-details');
            const mobilePressure = select('#mobile-show-pressure');
            const mobileFlows = select('#mobile-show-flows');
            const mobileForces = select('#mobile-show-forces');

            switch(preset) {
                case 'all':
                    if (desktopDetails) desktopDetails.checked(true);
                    if (desktopPressure) desktopPressure.checked(true);
                    if (desktopFlows) desktopFlows.checked(true);
                    if (desktopForces) desktopForces.checked(true);
                    if (mobileDetails) mobileDetails.checked(true);
                    if (mobilePressure) mobilePressure.checked(true);
                    if (mobileFlows) mobileFlows.checked(true);
                    if (mobileForces) mobileForces.checked(true);
                    break;
                case 'minimal':
                    if (desktopDetails) desktopDetails.checked(false);
                    if (desktopPressure) desktopPressure.checked(false);
                    if (desktopFlows) desktopFlows.checked(true);
                    if (desktopForces) desktopForces.checked(true);
                    if (mobileDetails) mobileDetails.checked(false);
                    if (mobilePressure) mobilePressure.checked(false);
                    if (mobileFlows) mobileFlows.checked(true);
                    if (mobileForces) mobileForces.checked(true);
                    break;
                case 'physics':
                    if (desktopDetails) desktopDetails.checked(false);
                    if (desktopPressure) desktopPressure.checked(true);
                    if (desktopFlows) desktopFlows.checked(false);
                    if (desktopForces) desktopForces.checked(true);
                    if (mobileDetails) mobileDetails.checked(false);
                    if (mobilePressure) mobilePressure.checked(true);
                    if (mobileFlows) mobileFlows.checked(false);
                    if (mobileForces) mobileForces.checked(true);
                    break;
            }
        }

        function exportChecklist() {
            let content = "# Checklist de Mejoras del Ala - Simulador de Sustentaci√≥n\n\n";
            content += "Generado: " + new Date().toLocaleString() + "\n\n";

            const categories = [...new Set(allChecklistItems.map(item => item.category))];

            categories.forEach(category => {
                content += `## ${category}\n\n`;
                allChecklistItems.filter(item => item.category === category).forEach(item => {
                    const status = item.status === 'completed' ? '‚úÖ' : item.status === 'pending' ? '‚è≥' : 'üí°';
                    content += `- ${status} **${item.item}**: ${item.description}\n`;
                });
                content += "\n";
            });

            // Create download link
            const blob = new Blob([content], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'checklist_ala.md';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function displayChecklist() {
            const desktopContainer = select('#checklist-items');
            const mobileContainer = select('#mobile-checklist-items');

            // Display on desktop container
            if (desktopContainer) {
                desktopContainer.html('');
                displayChecklistItems(desktopContainer);
            }

            // Display on mobile container
            if (mobileContainer) {
                mobileContainer.html('');
                displayChecklistItems(mobileContainer);
            }
        }

        function displayChecklistItems(container) {
            const categories = [...new Set(allChecklistItems.map(item => item.category))];

            categories.forEach((category, index) => {
                const categoryDiv = createDiv('');
                categoryDiv.class('checklist-category');
                categoryDiv.parent(container);

                const headerDiv = createDiv('');
                headerDiv.class('category-header');
                headerDiv.parent(categoryDiv);
                headerDiv.elt.onclick = () => toggleChecklistCategory(index);

                const headerH4 = createElement('h4', category);
                headerH4.parent(headerDiv);

                const toggleIcon = createSpan('‚ñ∂');
                toggleIcon.class('toggle-icon');
                toggleIcon.parent(headerDiv);

                const contentDiv = createDiv('');
                contentDiv.class('category-content');
                contentDiv.id(`${container.elt.id.replace('-items', '')}-category-${index}`);
                contentDiv.parent(categoryDiv);

                // Check if category should be expanded (from localStorage or default)
                const isExpanded = localStorage.getItem(`checklist-${index}-expanded`) !== 'false'; // Default to expanded
                contentDiv.elt.style.display = isExpanded ? 'block' : 'none';
                toggleIcon.elt.textContent = isExpanded ? '‚ñº' : '‚ñ∂';

                const categoryItems = allChecklistItems.filter(item => item.category === category);
                categoryItems.forEach(item => {
                    const itemDiv = createDiv('');
                    itemDiv.class(`check-item ${item.status}`);
                    itemDiv.parent(contentDiv);

                    const statusSpan = createSpan('');
                    statusSpan.class('status');
                    statusSpan.html(item.status === 'completed' ? '‚úì' : item.status === 'pending' ? '‚è≥' : 'üí°');
                    statusSpan.parent(itemDiv);

                    const textSpan = createSpan(` ${item.item}`);
                    textSpan.parent(itemDiv);

                    if (item.description) {
                        const descDiv = createDiv(item.description);
                        descDiv.class('description');
                        descDiv.parent(itemDiv);
                    }
                });
            });
        }

        function filterChecklist(searchTerm) {
            const items = selectAll('.check-item');
            const lowerSearch = searchTerm.toLowerCase();

            items.forEach(item => {
                const text = item.elt.textContent.toLowerCase();
                if (text.includes(lowerSearch)) {
                    item.elt.style.display = 'block';
                } else {
                    item.elt.style.display = 'none';
                }
            });

            // Show/hide clear button for both desktop and mobile
            const clearBtn = select('#clear-search');
            const mobileClearBtn = select('#mobile-clear-search');
            if (clearBtn) {
                clearBtn.elt.style.display = searchTerm ? 'block' : 'none';
            }
            if (mobileClearBtn) {
                mobileClearBtn.elt.style.display = searchTerm ? 'block' : 'none';
            }
        }

        function toggleChecklistCategory(categoryId) {
            // Toggle both desktop and mobile categories with the same ID
            const desktopContent = select(`#checklist-category-${categoryId}`);
            const mobileContent = select(`#mobile-checklist-category-${categoryId}`);

            // Toggle desktop
            if (desktopContent) {
                const isExpanded = desktopContent.elt.style.display !== 'none';
                desktopContent.elt.style.display = isExpanded ? 'none' : 'block';
                const desktopHeader = desktopContent.elt.previousElementSibling;
                if (desktopHeader) {
                    const toggleIcon = desktopHeader.querySelector('.toggle-icon');
                    if (toggleIcon) toggleIcon.textContent = isExpanded ? '‚ñ∂' : '‚ñº';
                }
                localStorage.setItem(`checklist-${categoryId}-expanded`, !isExpanded);
            }

            // Toggle mobile
            if (mobileContent) {
                const isExpanded = mobileContent.elt.style.display !== 'none';
                mobileContent.elt.style.display = isExpanded ? 'none' : 'block';
                const mobileHeader = mobileContent.elt.previousElementSibling;
                if (mobileHeader) {
                    const toggleIcon = mobileHeader.querySelector('.toggle-icon');
                    if (toggleIcon) toggleIcon.textContent = isExpanded ? '‚ñ∂' : '‚ñº';
                }
                localStorage.setItem(`checklist-${categoryId}-expanded`, !isExpanded);
            }
        }

        function draw() {
            clear();

            // Background gradient
            for (let y = 0; y < height; y++) {
                let inter = map(y, 0, height, 0, 1);
                let c = lerpColor(color(135, 206, 250), color(100, 180, 220), inter);
                stroke(c);
                line(0, y, width, y);
            }

            // Title
            fill(255);
            stroke(0);
            strokeWeight(max(1, 2 * scaleFactor));
            textSize(max(12, 20 * scaleFactor));
            textAlign(CENTER);
            text('Test del Ala - Checklist de Mejoras', width / 2, 35 * scaleFactor);

            // Draw airfoil
            push();
            translate(width / 2, height / 2);
            scale(1.2 * scaleFactor);
            rotate(angleAttack * 0.3);

            // Main airfoil profile
            fill(40, 40, 50);
            stroke(20, 20, 30);
            strokeWeight(3);

            beginShape();
            let leX = -150, leY = 0;
            vertex(leX, leY);
            bezierVertex(-100, -20, -50, -40, 0, -50);
            bezierVertex(50, -50, 100, -40, 150, -20);
            vertex(170, 0);
            bezierVertex(150, 10, 100, 20, 50, 25);
            bezierVertex(0, 25, -50, 20, -100, 10);
            bezierVertex(-125, 5, leX, leY);
            endShape(CLOSE);

            // Leading edge reinforcement
            fill(20, 20, 30);
            noStroke();
            ellipse(leX, leY, 12, 10);

            // Flaps for high angles
            if (degrees(angleAttack) > 15) {
                fill(100, 149, 237, 200);
                stroke(80, 129, 217);
                strokeWeight(2);
                beginShape();
                vertex(100, -45); vertex(140, -40); vertex(145, -30); vertex(105, -35);
                endShape(CLOSE);
                beginShape();
                vertex(100, 20); vertex(140, 15); vertex(145, 25); vertex(105, 30);
                endShape(CLOSE);
            }

            // Navigation light
            fill(0, 255, 0);
            stroke(0, 150, 0);
            strokeWeight(1);
            ellipse(165, -5, 8, 8);

            pop();

            // Flow visualization
            if (showFlows.checked()) {
                flowOffset += 0.02;

                // Upper flow (blue)
                stroke(135, 206, 235, 160);
                strokeWeight(2);
                noFill();
                for (let i = 0; i < 8; i++) {
                    let baseY = height / 2 - 35 - i * 4;
                    let xOffset = (flowOffset * 3 + i * 15) % (width + 200) - 100;
                    let curve = degrees(angleAttack) * 1.5;

                    beginShape();
                    vertex(xOffset, baseY);
                    bezierVertex(xOffset + 50, baseY - 10 - curve, xOffset + 120, baseY - 18 - curve, xOffset + 200, baseY - 5 - curve);
                    endShape();
                }

                // Lower flow (orange)
                stroke(255, 140, 100, 160);
                for (let i = 0; i < 8; i++) {
                    let baseY = height / 2 + 35 + i * 4;
                    let xOffset = (flowOffset * 1.5 + i * 15) % (width + 200) - 100;
                    let curve = degrees(angleAttack) * 1.2;

                    beginShape();
                    vertex(xOffset, baseY);
                    bezierVertex(xOffset + 50, baseY + 10 + curve, xOffset + 120, baseY + 18 + curve, xOffset + 200, baseY + 5 + curve);
                    endShape();
                }
            }

            // Pressure visualization
            if (showPressure.checked()) {
                push();
                translate(width / 2, height / 2);
                scale(1.2);

                // High pressure below (red)
                for (let layer = 0; layer < 3; layer++) {
                    fill(255, 100, 100, 20 - layer * 5);
                    noStroke();
                    beginShape();
                    for (let x = -120; x <= 120; x += 5) {
                        let yb = -0.12 * sin(PI * x / 240) * 50;
                        vertex(x, yb + 2 + layer);
                    }
                    vertex(120, 30 + layer);
                    vertex(-120, 30 + layer);
                    endShape(CLOSE);
                }

                // Low pressure above (blue)
                for (let layer = 0; layer < 3; layer++) {
                    fill(100, 150, 255, 15 - layer * 3);
                    noStroke();
                    beginShape();
                    for (let x = -120; x <= 120; x += 5) {
                        let yt = 0.12 * sin(PI * x / 240) * 50;
                        vertex(x, yt - 2 - layer);
                    }
                    vertex(120, -30 - layer);
                    vertex(-120, -30 - layer);
                    endShape(CLOSE);
                }

                pop();
            }

            // Forces
            if (showForces.checked()) {
                let leX = width / 2 - 180;
                let leY = height / 2;

                // Calculate lift magnitude based on angle of attack (simplified)
                let liftMagnitude = max(35, degrees(angleAttack) * 3.5 + 35);
                let weightMagnitude = 45; // Constant weight

                // Lift force (green) - upward arrow from center of wing
                let liftEndY = leY - liftMagnitude;
                drawArrow(leX, leY, leX, liftEndY, color(0, 255, 0), 5, 1.3);

                // Lift label with better visibility
                fill(0);
                stroke(255);
                strokeWeight(2);
                textSize(getResponsiveTextSize(13));
                textAlign(LEFT);
                text('Sustentaci√≥n', leX + 18, leY - liftMagnitude/2);

                fill(0, 255, 0);
                noStroke();
                textSize(getResponsiveTextSize(13));
                text('Sustentaci√≥n', leX + 18, leY - liftMagnitude/2);

                // Add lift value
                fill(0);
                stroke(255, 255, 255, 200);
                strokeWeight(1);
                textSize(getResponsiveTextSize(11));
                text((liftMagnitude * 0.08).toFixed(1) + ' N', leX + 18, leY - liftMagnitude/2 + 18);

                fill(0, 200, 0);
                noStroke();
                textSize(getResponsiveTextSize(11));
                text((liftMagnitude * 0.08).toFixed(1) + ' N', leX + 18, leY - liftMagnitude/2 + 18);

                // Weight force (red) - downward arrow from center
                let weightEndY = leY + weightMagnitude;
                drawArrow(leX, leY, leX, weightEndY, color(255, 0, 0), 5, 1.1);

                // Weight label with high contrast for better visibility
                fill(0);
                stroke(255);
                strokeWeight(3);
                textSize(getResponsiveTextSize(14));
                textAlign(LEFT);
                text('Peso', leX + 18, leY + weightMagnitude/2);

                fill(255, 0, 0);
                stroke(255, 255, 255, 150);
                strokeWeight(1);
                textSize(getResponsiveTextSize(14));
                text('Peso', leX + 18, leY + weightMagnitude/2);

                // Add weight value
                fill(0);
                stroke(255, 255, 255, 200);
                strokeWeight(1);
                textSize(getResponsiveTextSize(11));
                text((weightMagnitude * 0.08).toFixed(1) + ' N', leX + 18, leY + weightMagnitude/2 + 18);

                fill(200, 0, 0);
                noStroke();
                textSize(getResponsiveTextSize(11));
                text((weightMagnitude * 0.08).toFixed(1) + ' N', leX + 18, leY + weightMagnitude/2 + 18);

                // Drag force (orange) - horizontal arrow to the left
                let dragMagnitude = degrees(angleAttack) * 0.6 + 8; // Drag increases with angle
                let dragEndX = leX - dragMagnitude;
                drawArrow(leX, leY, dragEndX, leY, color(255, 140, 0), 4, 0.9);

                // Drag label
                fill(0);
                stroke(255);
                strokeWeight(2);
                textSize(getResponsiveTextSize(12));
                textAlign(CENTER);
                text('Resistencia', leX - dragMagnitude/2, leY - 10);

                fill(255, 140, 0);
                noStroke();
                textSize(getResponsiveTextSize(12));
                text('Resistencia', leX - dragMagnitude/2, leY - 10);

                // Add drag value
                fill(0);
                stroke(255, 255, 255, 200);
                strokeWeight(1);
                textSize(getResponsiveTextSize(10));
                text((dragMagnitude * 0.03).toFixed(2) + ' N', leX - dragMagnitude/2, leY + 8);

                fill(200, 100, 0);
                noStroke();
                textSize(getResponsiveTextSize(10));
                text((dragMagnitude * 0.03).toFixed(2) + ' N', leX - dragMagnitude/2, leY + 8);

                // Draw force balance indicator
                if (abs(liftMagnitude - weightMagnitude) < 15) {
                    fill(255, 255, 0, 180);
                    stroke(0);
                    strokeWeight(max(1, 2 * scaleFactor));
                    ellipse(leX, leY, 12 * scaleFactor, 12 * scaleFactor);
                    fill(0);
                    noStroke();
                    textSize(getResponsiveTextSize(10));
                    textAlign(CENTER);
                    text('‚â°', leX, leY + 3 * scaleFactor);
                }
            }

            // Labels
            if (showDetails.checked()) {
                fill(255);
                stroke(0);
                strokeWeight(1);
                textSize(10);
                textAlign(CENTER);
                text('NACA 2412', width / 2, height / 2 + 50);

                fill(135, 206, 235);
                textSize(12);
                textAlign(LEFT);
                text('Aire R√°pido (Baja Presi√≥n)', 50, height / 2 - 50);

                fill(255, 140, 100);
                text('Aire Lento (Alta Presi√≥n)', 50, height / 2 + 70);
            }
        }

        function drawArrow(x1, y1, x2, y2, arrowColor, weight = 4, scaleFactor = 1) {
            // Calculate arrow length and direction
            let dx = x2 - x1;
            let dy = y2 - y1;
            let length = sqrt(dx * dx + dy * dy);
            let angle = atan2(dy, dx);

            // Scale arrow based on length
            let arrowLength = max(25, length * 0.4) * scaleFactor;
            let arrowWidth = weight * 2.5 * scaleFactor;

            push();
            translate(x1, y1);
            rotate(angle);

            // Draw arrow shadow for depth
            stroke(0, 0, 0, 50);
            strokeWeight(weight + 2);
            line(2, 2, length - arrowLength + 2, 2);

            // Draw arrow shaft with gradient effect
            for (let i = 0; i < length - arrowLength; i += 3) {
                let alpha = map(i, 0, length - arrowLength, 255, 150);
                stroke(red(arrowColor), green(arrowColor), blue(arrowColor), alpha);
                strokeWeight(weight);
                line(i, 0, i + 3, 0);
            }

            // Draw arrowhead with better shape and shadow
            translate(length - arrowLength, 0);

            // Arrowhead shadow
            fill(0, 0, 0, 50);
            noStroke();
            triangle(2, 2, -arrowLength + 2, -arrowWidth/2 + 2, -arrowLength + 2, arrowWidth/2 + 2);

            // Main arrowhead
            fill(arrowColor);
            noStroke();
            triangle(0, 0, -arrowLength, -arrowWidth/2, -arrowLength, arrowWidth/2);

            // Add arrowhead base for better appearance
            rect(-arrowLength, -arrowWidth/4, arrowLength * 0.3, arrowWidth/2);

            pop();
        }
    </script>
</body>
</html>
